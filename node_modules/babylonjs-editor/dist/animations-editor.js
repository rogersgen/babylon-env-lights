!function(e){function t(e){Object.defineProperty(this,e,{enumerable:!0,get:function(){return this[v][e]}})}function r(e){if("undefined"!=typeof System&&System.isModule?System.isModule(e):"[object Module]"===Object.prototype.toString.call(e))return e;var t={default:e,__useDefault:e};if(e&&e.__esModule)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return new o(t)}function o(e){Object.defineProperty(this,v,{value:e}),Object.keys(e).forEach(t,this)}function n(e){return"@node/"===e.substr(0,6)?c(e,r(m(e.substr(6))),{}):p[e]}function u(e){var t=n(e);if(!t)throw new Error('Module "'+e+'" expected, but not contained in build.');if(t.module)return t.module;var r=t.linkRecord;return i(t,r),a(t,r,[]),t.module}function i(e,t){if(!t.depLoads){t.declare&&d(e,t),t.depLoads=[];for(var r=0;r<t.deps.length;r++){var o=n(t.deps[r]);t.depLoads.push(o),o.linkRecord&&i(o,o.linkRecord);var u=t.setters&&t.setters[r];u&&(u(o.module||o.linkRecord.moduleObj),o.importerSetters.push(u))}return e}}function d(t,r){var o=r.moduleObj,n=t.importerSetters,u=!1,i=r.declare.call(e,function(e,t){if(!u){if("object"==typeof e)for(var r in e)"__useDefault"!==r&&(o[r]=e[r]);else o[e]=t;u=!0;for(var i=0;i<n.length;i++)n[i](o);return u=!1,t}},{id:t.key});"function"!=typeof i?(r.setters=i.setters,r.execute=i.execute):(r.setters=[],r.execute=i)}function l(e,t,r){return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:r,setters:void 0,execute:void 0,moduleObj:{}}}}function f(e,t,r,o){var n={};return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:void 0,execute:o,executingRequire:r,moduleObj:{default:n,__useDefault:n},setters:void 0}}}function s(e,t,r){return function(o){for(var n=0;n<e.length;n++)if(e[n]===o){var u,i=t[n],d=i.linkRecord;return u=d?-1===r.indexOf(i)?a(i,d,r):d.moduleObj:i.module,"__useDefault"in u?u.__useDefault:u}}}function a(t,r,n){if(n.push(t),t.module)return t.module;if(r.setters){for(var i=0;i<r.deps.length;i++){var d=r.depLoads[i],l=d.linkRecord;l&&-1===n.indexOf(d)&&a(d,l,l.setters?n:[])}r.execute.call(y)}else{var f={id:t.key},c=r.moduleObj;Object.defineProperty(f,"exports",{configurable:!0,set:function(e){c.default=c.__useDefault=e},get:function(){return c.__useDefault}});var p=s(r.deps,r.depLoads,n);if(!r.executingRequire)for(var i=0;i<r.deps.length;i++)p(r.deps[i]);var v=r.execute.call(e,p,c.__useDefault,f);void 0!==v?c.default=c.__useDefault=v:f.exports!==c.__useDefault&&(c.default=c.__useDefault=f.exports);var m=c.__useDefault;if(m&&m.__esModule)for(var b in m)Object.hasOwnProperty.call(m,b)&&(c[b]=m[b])}var f=t.module=new o(r.moduleObj);if(!r.setters)for(var i=0;i<t.importerSetters.length;i++)t.importerSetters[i](f);return f}function c(e,t){return p[e]={key:e,module:t,importerSetters:[],linkRecord:void 0}}var p={},v="undefined"!=typeof Symbol?Symbol():"@@baseObject";o.prototype=Object.create(null),"undefined"!=typeof Symbol&&Symbol.toStringTag&&(o.prototype[Symbol.toStringTag]="Module");var m="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&void 0!==require.resolve&&"undefined"!=typeof process&&process.platform&&require,y={};return Object.freeze&&Object.freeze(y),function(e,t,n,i){return function(d){d(function(d){var s={_nodeRequire:m,register:l,registerDynamic:f,registry:{get:function(e){return p[e].module},set:c},newModule:function(e){return new o(e)}};c("@empty",new o({}));for(var a=0;a<t.length;a++)c(t[a],r(arguments[a],{}));i(s);var v=u(e[0]);if(e.length>1)for(var a=1;a<e.length;a++)u(e[a]);return n?v.__useDefault:(v instanceof o&&Object.defineProperty(v,"__esModule",{value:!0}),v)})}}}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this)(["a"],["c","d","f"],!0,function($__System){this.require,this.exports,this.module;$__System.registerDynamic("b",["c","d"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),babylonjs_editor_1=$__require("d"),PropertyBrowser=function(){function PropertyBrowser(object){var _this=this;this._allowedTypes=["Vector2","Vector3","Vector4","Color3","Color4","Quaternion","Number","number"],this._deepTypes=[babylonjs_1.Material,babylonjs_1.Camera],this._window=new babylonjs_editor_1.Window("PropertyBrowser"),this._window.body='<div id="ANIMATION-EDITOR-PROPERTY-BORWSER" style="width: 100%; height: 100%;"></div>',this._window.title="Select Property...",this._window.buttons=["Select","Cancel"],this._window.open(),this._window.onButtonClick=function(id){switch(id){case"Select":var selected=_this._graph.element.selected;if(void 0===_this._graph.element.get(selected).data)return;selected&&_this.onSelect&&_this.onSelect(selected)}_this._graph.element.destroy(),_this._window.close()},this._graph=new babylonjs_editor_1.Graph("PropertyGraph"),this._graph.build("ANIMATION-EDITOR-PROPERTY-BORWSER"),this._fillGraph(object)}return PropertyBrowser.prototype.getPropertyInfos=function(object,propertyPath){for(var parts=propertyPath.split("."),_i=0,parts_1=parts;_i<parts_1.length;_i++){object=object[parts_1[_i]]}var ctor=babylonjs_editor_1.Tools.GetConstructorName(object),type=babylonjs_1.Animation.ANIMATIONTYPE_FLOAT,defaultValue=0;switch(ctor){case"Vector2":type=babylonjs_1.Animation.ANIMATIONTYPE_VECTOR2,defaultValue=babylonjs_1.Vector2.Zero();break;case"Vector3":type=babylonjs_1.Animation.ANIMATIONTYPE_VECTOR3,defaultValue=babylonjs_1.Vector3.Zero();break;case"Color3":type=babylonjs_1.Animation.ANIMATIONTYPE_COLOR3,defaultValue=babylonjs_1.Color3.Black();break;case"Quaternion":type=babylonjs_1.Animation.ANIMATIONTYPE_QUATERNION,defaultValue=babylonjs_1.Quaternion.Identity()}return{type:type,defaultValue:defaultValue}},PropertyBrowser.prototype._fillGraph=function(root,node){node||(node=this._getPropertyNodes(root,"",{id:void 0,text:"",img:"",children:[]})),babylonjs_editor_1.Tools.SortAlphabetically(node.children,"text");for(var _i=0,_a=node.children;_i<_a.length;_i++){var n=_a[_i];this._graph.add({id:n.id,img:n.img,text:n.text,data:n.data},node.id),this._fillGraph(root,n)}},PropertyBrowser.prototype._getPropertyNodes=function(root,rootName,rootNode){var _loop_1=function(thing){var value=root[thing],ctor=babylonjs_editor_1.Tools.GetConstructorName(value);if("_"===thing[0])return"continue";var id=(""===rootName?"":rootName+".")+thing,allowed="emitter"===thing&&root instanceof babylonjs_1.ParticleSystem||-1!==this_1._allowedTypes.indexOf(ctor),deep=this_1._deepTypes.find(function(dt){return value instanceof dt});if(!allowed&&!deep)return"continue";if(deep){var node={id:id,text:thing+" - ("+ctor+")",img:"icon-error",children:[]};rootNode.children.push(node),this_1._getPropertyNodes(value,id,node)}else if(allowed){var node={id:id,text:thing+" - ("+ctor+")",img:this_1._getIcon(value),data:value,children:[]};rootNode.children.push(node),this_1._getPropertyNodes(value,id,node)}},this_1=this;for(var thing in root)_loop_1(thing);return rootNode},PropertyBrowser.prototype._getIcon=function(obj){return obj instanceof babylonjs_1.Vector2||obj instanceof babylonjs_1.Vector3||obj instanceof babylonjs_1.Vector4||obj instanceof babylonjs_1.Quaternion?"icon-position":obj instanceof babylonjs_1.Color3||obj instanceof babylonjs_1.Color4?"icon-effects":"icon-edit"},PropertyBrowser}();exports.default=PropertyBrowser}),$__System.registerDynamic("e",["c"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),Helpers=function(){function Helpers(){}return Helpers.DisposePositionLineMesh=function(){this._PositionLineMesh&&(this._PositionLineMesh.dispose(),this._PositionLineMesh=null)},Helpers.AddPositionLineMesh=function(scene,animation){if(this.DisposePositionLineMesh(),"position"===animation.targetProperty){var keys=animation.getKeys();return this._PositionLineMesh=babylonjs_1.Mesh.CreateLines("PositionHelperAnimationEditor",keys.map(function(k){return k.value}),scene),this._PositionLineMesh.enableEdgesRendering(),this._PositionLineMesh.doNotSerialize=!0,babylonjs_1.Tags.AddTagsTo(this._PositionLineMesh,"graph-hidden"),this._PositionLineMesh}},Helpers.GetEffectiveProperty=function(animatable,animation){var value=animatable;return animation.targetPropertyPath.forEach(function(tpp){return value=value[tpp]}),value},Helpers.ProjectToGraph=function(frame,maxFrame,width,middle,value,valueInterval){var x=frame*width/maxFrame,y=middle;return 0!==value&&0!==maxFrame&&(y+=value*middle/(valueInterval*(value>0?1:-1))*(value>0?-1:1)/2),new babylonjs_1.Vector2(x,y)},Helpers.ScaleValue=function(value,amount){return value.scale?value.scale(amount):value*amount},Helpers.ComputeTangents=function(animation,amount){var keys=animation.getKeys(),path=new babylonjs_1.Path3D(keys.map(function(k){return k.value})),tangents=path.getTangents();keys.forEach(function(k,index){k.inTangent=0===amount?void 0:tangents[index].multiplyByFloats(amount,amount,amount),k.outTangent=0===amount?void 0:tangents[index].multiplyByFloats(amount,amount,amount)})},Helpers._PositionLineMesh=null,Helpers}();exports.default=Helpers}),$__System.registerDynamic("a",["c","f","d","b","e"],!0,function($__require,exports,module){"use strict";var __extends=(this||self,exports&&exports.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}()),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=exports&&exports.__generator||function(thisArg,body){function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(t=_.trys,!(t=t.length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),Raphael=$__require("f"),babylonjs_editor_1=$__require("d"),property_browser_1=$__require("b"),helpers_1=$__require("e"),AnimationEditor=function(_super){function AnimationEditor(editor,forcedObject){var _this=_super.call(this,"Animation Editor")||this;return _this.editor=editor,_this.layout=null,_this.toolbar=null,_this.editToolbar=null,_this.frameInput=null,_this.valueInput=null,_this.paper=null,_this.background=null,_this.middleLine=null,_this.noDataText=null,_this.valueText=null,_this.lines=[],_this.points=[],_this.timeline=null,_this.timelineLines=[],_this.timelineTexts=[],_this.cursorRect=null,_this.cursorLine=null,_this.animatable=null,_this.animation=null,_this.animationManager=null,_this.key=null,_this.data=null,_this.currentFrame=0,_this.addingKeys=!1,_this.removingKeys=!1,_this.isPlaying=!1,_this.onObjectSelected=function(node){return node&&_this.objectSelected(node)},_this.onKeyDown=null,_this.onKeyUp=null,_this._positionHelperMesh=null,_this._positionHelperTimeout=-1,_this._xLocked=!1,_this._viewBox=new babylonjs_1.Vector4(0,0,0,0),_this._viewScale=1,_this.forcedObject=forcedObject,_this}return __extends(AnimationEditor,_super),AnimationEditor.prototype.create=function(){return __awaiter(this,void 0,void 0,function(){var frame,value,_this=this;return __generator(this,function(_a){return this.layout=new babylonjs_editor_1.Layout("AnimationEditorLayout"),this.layout.panels=[{type:"top",content:'<div id="ANIMATION-EDITOR-TOOLBAR" style="width: 100%; height: 100%;"></div>',size:AnimationEditor.PaperOffset,resizable:!1},{type:"preview",content:'<div id="ANIMATION-EDITOR-TOOLBAR-EDIT" style="width: 100%; height: 100%;"></div>',size:AnimationEditor.PaperOffset,resizable:!1},{type:"main",content:'<div id="ANIMATION-EDITOR-PAPER" style="width: 100%; height: 100%; overflow: hidden;"></div>',resizable:!1}],this.layout.build("AnimationEditor"),this.toolbar=new babylonjs_editor_1.Toolbar("AnimationEditorToolbar"),this.toolbar.items=[{type:"button",id:"play",text:"Play",img:"icon-play-game",checked:!1},{type:"break"},{type:"button",id:"add",text:"Add",img:"icon-add",checked:!1},{type:"button",id:"remove-animation",text:"Remove Animation",img:"icon-error"},{type:"break"},{type:"menu",id:"animations",text:"Animations",img:"icon-animated-mesh",items:[]},{type:"break"},{type:"menu",id:"tools",text:"Tools",img:"icon-edit",items:[{type:"button",id:"tangents",img:"icon-graph",text:"Create Tangents..."}]}],this.toolbar.right="No object selected",this.toolbar.onClick=function(id){return _this.onToolbarClick(id)},this.toolbar.helpUrl="http://doc.babylonjs.com/resources/adding_animations",this.toolbar.build("ANIMATION-EDITOR-TOOLBAR"),this.editToolbar=new babylonjs_editor_1.Toolbar("AnimationEditorToolbarEdit"),this.editToolbar.items=[{type:"button",id:"add-key",text:"Add Keys",img:"icon-add",checked:!1},{type:"button",id:"remove-key",text:"Remove Keys",img:"icon-error",checked:!1},{type:"break"},{type:"button",id:"add-key-current",text:"Add Current Key",img:"icon-add"}],this.editToolbar.right='\n            <div style="padding: 3px 10px;">\n                Value: <input size="10" id="ANIMATION-EDITOR-VALUE" style="height: 20px; padding: 3px; border-radius: 2px; border: 1px solid silver;" value="0" />\n                Frame: <input size="10" id="ANIMATION-EDITOR-FRAME" style="height: 20px; padding: 3px; border-radius: 2px; border: 1px solid silver;" value="0" />\n            </div>',this.editToolbar.onClick=function(id){return _this.onEditorToolbarClick(id)},this.editToolbar.build("ANIMATION-EDITOR-TOOLBAR-EDIT"),this.paper=Raphael($("#ANIMATION-EDITOR-PAPER")[0],0,0),this.paper.canvas.addEventListener("focus",function(){_this.animation&&_this.editor.inspector.setObject(_this.animation)}),document.addEventListener("keydown",this.onKeyDown=function(ev){_this._xLocked="x"===ev.key}),document.addEventListener("keyup",this.onKeyUp=function(ev){"x"===ev.key&&(_this._xLocked=!1)}),this.paper.canvas.addEventListener("wheel",function(ev){if(ev.deltaY<0?(_this._viewBox.x*=.95,_this._viewBox.y*=.95):(_this._viewBox.x*=1.05,_this._viewBox.y*=1.05),_this._viewScale=_this.paper.width/_this._viewBox.x,_this._viewScale<1)return _this._viewScale=1,_this._viewBox.set(_this.paper.width,_this.paper.height,0,0),void _this.paper.setViewBox(0,0,_this.paper.width,_this.paper.height,!0);var moveX=ev.offsetX-ev.offsetX*_this._viewScale,moveY=ev.offsetY-ev.offsetY*_this._viewScale;_this._viewBox.z=0-moveX/_this._viewScale,_this._viewBox.w=0-moveY/_this._viewScale,_this.paper.setViewBox(_this._viewBox.z,_this._viewBox.w,_this._viewBox.x,_this._viewBox.y,!0),_this.points.forEach(function(p){return p.transform("S"+1/_this._viewScale)})}),this.background=this.paper.rect(0,0,0,0),this.background.attr("fill","#ddd"),this.background.attr("stroke","#ddd"),this.middleLine=this.paper.rect(0,0,0,1),this.middleLine.attr("fill","#eee"),this.middleLine.attr("stroke","#eee"),this.noDataText=this.paper.text(0,0,"No Animation Selected"),this.noDataText.node.style.pointerEvents="none",this.noDataText.node.style.userSelect="none",this.noDataText.attr("font-size",64),this.valueText=this.paper.text(0,0,"0.0"),this.valueText.node.style.pointerEvents="none",this.valueText.node.style.userSelect="none",this.valueText.attr("font-size",10),this.valueText.hide(),frame=$("#ANIMATION-EDITOR-FRAME"),this.frameInput=frame.w2field("float",{autoFormat:!0}),this.frameInput[0].addEventListener("change",function(ev){if(_this.key){var fromFrame_1=_this.key.frame,toFrame_1=parseFloat(_this.frameInput.val());_this.key.frame=toFrame_1,_this.updateGraph(_this.animation);var animation_1=_this.animation,key=_this.key;babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,object:key,property:"frame",from:fromFrame_1,to:toFrame_1,fn:function(type){_this.updateGraph(animation_1),_this.frameInput.val("from"===type?fromFrame_1:toFrame_1)}})}}),value=$("#ANIMATION-EDITOR-VALUE"),this.valueInput=value.w2field("float",{autoFormat:!0}),this.valueInput[0].addEventListener("change",function(ev){if(_this.key&&_this.data){var fromValue_1=""===_this.data.property?_this.key.value:_this.key.value[_this.data.property],toValue_1=parseFloat(_this.valueInput.val());""===_this.data.property?_this.key.value=toValue_1:_this.key.value[_this.data.property]=toValue_1,_this.updateGraph(_this.animation),babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,object:_this.key,property:""===_this.data.property?"value":"value."+_this.data.property,from:fromValue_1,to:toValue_1,fn:function(type){_this.updateGraph(_this.animation),_this.frameInput.val("from"===type?fromValue_1:toValue_1)}})}}),this.objectSelected(this.forcedObject||this.editor.core.currentSelectedObject),this.forcedObject||this.editor.core.onSelectObject.add(this.onObjectSelected),[2]})})},AnimationEditor.prototype.close=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return _super.prototype.close.call(this),this.editor.core.onSelectObject.removeCallback(this.onObjectSelected),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),this.paper.remove(),this.layout.element.destroy(),this.toolbar.element.destroy(),this.editToolbar.element.destroy(),helpers_1.default.DisposePositionLineMesh(),babylonjs_editor_1.UndoRedo.ClearScope(this.divElement.id),[4,_super.prototype.close.call(this)];case 1:return _a.sent(),[2]}})})},AnimationEditor.prototype.onShow=function(forcedObject){this.forcedObject=forcedObject,this.editor.core.onSelectObject.removeCallback(this.onObjectSelected),forcedObject?this.objectSelected(forcedObject):this.editor.core.onSelectObject.add(this.onObjectSelected),this.onResize(),this._positionHelperMesh&&this._positionHelperMesh.setEnabled(!0)},AnimationEditor.prototype.onHide=function(){this._positionHelperMesh&&this._positionHelperMesh.setEnabled(!1)},AnimationEditor.prototype.onResize=function(){var _this=this;this.layout.element.resize(),setTimeout(function(){if(!_this.closed){var size=_this.layout.getPanelSize("main");_this.paper.setSize(size.width,size.height),_this.background.attr("width",size.width),_this.background.attr("height",size.height),_this.middleLine.attr("width",size.width),_this.middleLine.attr("y",size.height/2),_this.noDataText.attr("y",size.height/2-_this.noDataText.attr("height")/2),_this.noDataText.attr("x",size.width/2-_this.noDataText.attr("width")/2),_this.updateGraph(_this.animation)}},250)},AnimationEditor.prototype.onToolbarClick=function(id){return __awaiter(this,void 0,void 0,function(){var split,_a,index_1,animation_2,animatable_1,weight,_b,_this=this;return __generator(this,function(_c){switch(_c.label){case 0:if(split=id.split(":"),split.length>1&&"animations"===split[0])return this.onChangeAnimation(split[1]),[2];switch(_a=id){case"play":return[3,1];case"add":return[3,2];case"remove-animation":return[3,3];case"tools:tangents":return[3,4]}return[3,6];case 1:return this.playAnimation(),[3,7];case 2:return this.addAnimation(),[3,7];case 3:return this.animation&&(index_1=this.animatable.animations.indexOf(this.animation),animation_2=this.animation,animatable_1=this.animatable,babylonjs_editor_1.UndoRedo.Push({scope:this.divElement.id,fn:function(type){"from"===type?_this.animatable.animations.splice(index_1,0,animation_2):_this.animatable.animations.splice(index_1,1),_this.objectSelected(animatable_1)}}),this.animatable.animations.splice(index_1,1),this.objectSelected(this.animatable)),[3,7];case 4:return this.animation?this.animation.dataType!==babylonjs_1.Animation.ANIMATIONTYPE_VECTOR3?[2,babylonjs_editor_1.Window.CreateAlert("Tangents can be created only on animated 3D vectors.","Informations")]:(_b=parseFloat,[4,babylonjs_editor_1.Dialog.CreateWithTextInput("Tangents Weight?")]):[2];case 5:return weight=_b.apply(void 0,[_c.sent()])||0,helpers_1.default.ComputeTangents(this.animation,weight),this.updateGraph(this.animation),[3,7];case 6:return[3,7];case 7:return[2]}})})},AnimationEditor.prototype.onEditorToolbarClick=function(id){switch(id){case"add-key":case"remove-key":var active=this.editToolbar.isChecked(id,!0);this.editToolbar.setChecked("add-key",!1),this.editToolbar.setChecked("remove-key",!1),this.editToolbar.setChecked(id,active),this.addingKeys=active&&"add-key"===id,this.removingKeys=active&&"remove-key"===id;break;case"add-key-current":this.addCurrentValueToCurrentFrame()}},AnimationEditor.prototype.addAnimation=function(){var _this=this;if(this.animatable){var browser=new property_browser_1.default(this.animatable);browser.onSelect=function(id){var infos=browser.getPropertyInfos(_this.animatable,id),defaultValue=infos.defaultValue,split=id.split("."),effectiveValue=_this.animatable;switch(split.forEach(function(s){return effectiveValue=effectiveValue[s]}),babylonjs_editor_1.Tools.GetConstructorName(effectiveValue)){case"Number":defaultValue=effectiveValue;break;case"Vector2":case"Vector3":case"Vector4":case"Color3":case"Color4":case"Quaternion":defaultValue=effectiveValue.clone()}var anim=new babylonjs_1.Animation(id,id,60,infos.type,babylonjs_1.Animation.ANIMATIONLOOPMODE_CYCLE,!1);anim.setKeys([{frame:0,value:defaultValue},{frame:60,value:defaultValue}]);var length=_this.animatable.animations.push(anim);babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,fn:function(type){"from"===type?_this.animatable.animations.splice(length-1,1):_this.animatable.animations.splice(length-1,0,anim),_this.objectSelected(_this.animatable)}}),_this.objectSelected(_this.animatable),babylonjs_1.Tags.AddTagsTo(anim,"added")}}},AnimationEditor.prototype.playAnimation=function(){var _this=this;if(this.animatable&&this.animation){if(this.isPlaying)return this.cursorRect.stop(),this.cursorRect.attr("x",-this.cursorRect.attr("width")/2),this.cursorLine.stop(),this.cursorLine.attr("x",0),this.editor.core.scene.stopAnimation(this.animatable),this.toolbar.element.uncheck("play"),void(this.isPlaying=!1);var keys=this.animation.getKeys(),min=this.currentFrame||keys[0].frame,max=keys[keys.length-1].frame;if(void 0!==min&&void 0!==max){var time=1e3*(max-min)/this.animation.framePerSecond;this.cursorRect.animate({x:this.paper.width-this.cursorRect.attr("width")/2},time),this.cursorLine.animate({x:this.paper.width},time),this.editor.core.scene.beginDirectAnimation(this.animatable,[this.animation],min,max,!1,1,function(){_this.isPlaying=!1}),this.toolbar.element.check("play"),this.isPlaying=!0}}},AnimationEditor.prototype.objectSelected=function(object){if(this.toolbar.element.disable("remove-animation"),this.animatable=null,this.animation=null,this.frameInput.val(""),this.valueInput.val(""),helpers_1.default.DisposePositionLineMesh(),object&&(this.toolbar.element.right='Selected object: "'+(object instanceof babylonjs_1.Scene?"Scene":object.name)+'"',this.toolbar.element.render(),this._viewScale=1,this._viewBox.set(this.paper.width,this.paper.height,0,0),this.paper.setViewBox(0,0,this.paper.width,this.paper.height,!0),object.animations)){this.editor.core.scene.stopAnimation(object);var animations=["None"];object.animations.forEach(function(a){animations.push(a.name)});var menu=this.toolbar.element.get("animations");menu.items=[],animations.forEach(function(a){menu.items.push({id:a,caption:a,text:a})}),this.toolbar.element.refresh(),this.animatable=object,object.animations.length>0?this.onChangeAnimation(object.animations[0].name):(this.updateGraph(null),this.noDataText.show())}},AnimationEditor.prototype.onChangeAnimation=function(property){if(this.key=null,this.data=null,this._viewScale=1,this._viewBox.set(this.paper.width,this.paper.height,0,0),this.paper.setViewBox(0,0,this.paper.width,this.paper.height,!0),this.animatable){if(this.noDataText.show(),this.animation=this.animatable.animations.find(function(a){return a.name===property}),!this.animation)return this.toolbar.element.disable("remove-animation"),this.updateGraph(this.animation);this.noDataText.hide(),this.toolbar.element.enable("remove-animation");var keys=this.animation.getKeys(),maxFrame=keys[keys.length-1].frame;this.animationManager&&this.animationManager.stop(),this.animationManager=new babylonjs_1.Animatable(this.editor.core.scene,this.animatable,keys[0].frame,maxFrame,!1,1),this.animationManager.appendAnimations(this.animatable,this.animatable.animations),this.animationManager.stop(),this.updateGraph(this.animation),this._positionHelperMesh=helpers_1.default.AddPositionLineMesh(this.editor.core.scene,this.animation)}},AnimationEditor.prototype.updateGraph=function(anim){var _this=this;if(this.lines.forEach(function(l){return l.remove()}),this.points.forEach(function(p){return p.remove()}),this.timelineLines.forEach(function(tl){return tl.remove()}),this.timelineTexts.forEach(function(t){return t.remove()}),this.lines=[],this.points=[],this.timelineLines=[],this.timelineTexts=[],this.cursorRect&&this.cursorRect.remove(),this.cursorLine&&this.cursorLine.remove(),this.timeline&&this.timeline.remove(),this.currentFrame=0,!anim)return this._viewScale=1,this._viewBox.set(this.paper.width,this.paper.height,0,0),void this.paper.setViewBox(0,0,this.paper.width,this.paper.height,!0);var keys=anim.getKeys();if(0!==keys.length){var properties=AnimationEditor._Properties[babylonjs_editor_1.Tools.GetConstructorName(keys[0].value)],maxFrame=keys[keys.length-1].frame,middle=this.paper.height/2,maxValue=0,minValue=0;properties.forEach(function(p,propertyIndex){keys.forEach(function(k){if(""===p)return void(k.value>maxValue?maxValue=k.value:k.value<minValue&&(minValue=k.value));k.value[p]>maxValue?maxValue=k.value[p]:k.value[p]<minValue&&(minValue=k.value[p])})});for(var valueInterval=Math.max(Math.abs(maxValue),Math.abs(minValue))||1,linesCount=100,i=0;i<linesCount;i++){var x=this.paper.width/linesCount*i,line=this.paper.rect(x,0,1,20);if(line.attr("opacity",.05),i%5==0&&i>0){line.attr("opacity",1);var text=this.paper.text(x,30,(x*maxFrame/this.paper.width).toFixed(2));text.node.style.pointerEvents="none",text.node.style.userSelect="none",text.attr("opacity",.4),this.timelineTexts.push(text)}var highLine=this.paper.rect(x,20,1,this.paper.height-20);highLine.attr("opacity",.05),this.timelineLines.push(line),this.timelineLines.push(highLine)}linesCount=50;for(var currentValue=2*maxValue,i=0;i<linesCount;i++){var y=this.paper.height/linesCount*i,line=this.paper.rect(0,y,20,1);if(line.attr("opacity",.05),i%5==0){if(i>0){var text=this.paper.text(30,y,currentValue.toFixed(2));text.attr("opacity",.4),text.node.style.pointerEvents="none",text.node.style.userSelect="none",this.timelineTexts.push(text)}currentValue-=maxValue/(linesCount/10)*2}this.timelineLines.push(line)}this.timeline=this.paper.rect(0,0,this.paper.width,20),this.timeline.attr("fill",Raphael.rgb(0,0,0)),this.timeline.attr("opacity",.2),this.onClickTimeline(maxFrame),this.cursorLine=this.paper.rect(0,0,1,this.paper.height),this.cursorLine.attr("opacity",.5),this.cursorRect=this.paper.rect(-20,0,40,20),this.cursorRect.attr("fill",Raphael.rgb(0,0,0)),this.cursorRect.attr("opacity",.5),this.onMoveCursor(maxFrame),this.onPaperMove(properties,maxFrame,valueInterval,keys),properties.forEach(function(p,propertyIndex){var color=AnimationEditor.Colors[propertyIndex],path=[],line=_this.paper.path();keys.forEach(function(k,keyIndex){var value=""===p?k.value:k.value[p],position=helpers_1.default.ProjectToGraph(k.frame,maxFrame,_this.paper.width,middle,value,valueInterval);isNaN(position.x)&&(position.x=0),isNaN(position.y)&&(position.y=0),0===keyIndex&&(position.x=6),keyIndex===keys.length-1&&(position.x-=6);var point=_this.paper.circle(position.x,position.y,6);point.attr("fill",Raphael.rgb(color.r,color.g,color.b)),point.transform("S"+1/_this._viewScale),point.attr("opacity",.3),_this.points.push(point),_this.onMovePoint({point:point,keyIndex:keyIndex,line:line,property:p,properties:properties,maxFrame:maxFrame,valueInterval:valueInterval,middle:middle});var previousKey=keys[keyIndex-1];if(previousKey&&previousKey.outTangent&&k.inTangent){var frameDiff=k.frame-previousKey.frame,v1=babylonjs_1.Vector3.Hermite(previousKey.value,helpers_1.default.ScaleValue(previousKey.outTangent,frameDiff),k.value,helpers_1.default.ScaleValue(k.inTangent,frameDiff),.33),v2=babylonjs_1.Vector3.Hermite(previousKey.value,helpers_1.default.ScaleValue(previousKey.outTangent,frameDiff),k.value,helpers_1.default.ScaleValue(k.inTangent,frameDiff),.66),p1=helpers_1.default.ProjectToGraph(previousKey.frame+.33*frameDiff,maxFrame,_this.paper.width,middle,v1[p],valueInterval),p2=helpers_1.default.ProjectToGraph(previousKey.frame+.66*frameDiff,maxFrame,_this.paper.width,middle,v2[p],valueInterval);path.push.apply(path,["R",p1.x.toString(),p1.y.toString(),p2.x.toString(),p2.y.toString()])}0===keyIndex&&path.push("M"),path.push(position.x.toString()),path.push(position.y.toString())}),line.attr("stroke",Raphael.rgb(color.r,color.g,color.b)),line.attr("path",path),_this.lines.push(line)}),this._positionHelperMesh=helpers_1.default.AddPositionLineMesh(this.editor.core.scene,this.animation)}},AnimationEditor.prototype.addCurrentValueToCurrentFrame=function(){for(var _this=this,keys=this.animation.getKeys(),keyIndex=0,key={frame:this.currentFrame,value:null},i=0;i<keys.length;i++)if(keys[i].frame>this.currentFrame){keyIndex=i,keys.splice(i,0,key);break}var effectiveValue=helpers_1.default.GetEffectiveProperty(this.animatable,this.animation);switch(babylonjs_editor_1.Tools.GetConstructorName(effectiveValue)){case"Number":key.value=effectiveValue;break;case"Vector2":case"Vector3":case"Vector4":case"Color3":case"Color4":case"Quaternion":key.value=effectiveValue.clone();break;default:return}var animation=this.animation;babylonjs_editor_1.UndoRedo.Push({scope:this.divElement.id,fn:function(type){"from"===type?animation.getKeys().splice(keyIndex,1):animation.getKeys().splice(keyIndex,0,key),_this.updateGraph(animation)}}),this.updateGraph(this.animation)},AnimationEditor.prototype.onMovePoint=function(data){var _this=this,ox=0,oy=0,lx=0,ly=0,fromFrame=0,toFrame=0,fromValue=null,toValue=null,onStart=function(x,y,ev){if(_this.removingKeys){var key_1=_this.animation.getKeys()[data.keyIndex],animation_3=_this.animation;return babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,fn:function(type){"from"===type?animation_3.getKeys().splice(data.keyIndex,0,key_1):animation_3.getKeys().splice(data.keyIndex,1),_this.updateGraph(animation_3)}}),_this.animation.getKeys().splice(data.keyIndex,1),_this.updateGraph(_this.animation)}data.point.attr("opacity",1),_this.valueText.show(),_this.key=_this.animation.getKeys()[data.keyIndex],_this.data=data,_this.frameInput.val(_this.key.frame),""===data.property?(_this.valueInput.val(_this.key.value),fromValue=_this.key.value):(_this.valueInput.val(_this.key.value[data.property]),fromValue=_this.key.value[data.property]),fromFrame=_this.key.frame},onMove=function(dx,dy,x,y,ev){lx=(dx+ox)/_this._viewScale,ly=(dy+oy)/_this._viewScale,data.point.transform("t"+(_this._xLocked?0:lx)+","+ly);var path=data.line.attr("path"),key=path[data.keyIndex];3===key.length?(key[1]=data.point.attr("cx")+(_this._xLocked?0:lx),key[2]=data.point.attr("cy")+ly):(key=path[2*data.keyIndex],key[5]=data.point.attr("cx")+(_this._xLocked?0:lx),key[6]=data.point.attr("cy")+ly),data.line.attr("path",path);var frame=babylonjs_1.Scalar.Clamp((ev.offsetX+_this._viewBox.z*_this._viewScale)/_this._viewScale*data.maxFrame/_this.paper.width,0,data.maxFrame-1);toValue=0,toValue=ev.offsetY>_this.paper.height/2?-((ev.offsetY+_this._viewBox.w*_this._viewScale)/_this._viewScale-_this.paper.height/2)*data.valueInterval/(_this.paper.height/2)*2:(_this.paper.height/2-(ev.offsetY+_this._viewBox.w*_this._viewScale)/_this._viewScale)*data.valueInterval/(_this.paper.height/2)*2,_this._xLocked||(_this.key.frame=frame),toFrame=frame,""===data.property?_this.key.value=toValue:_this.key.value[data.property]=toValue,_this.frameInput.val(frame),_this.valueInput.val(""===data.property?toValue:_this.key.value[data.property]),_this.valueText.attr("x",(ev.offsetX+_this._viewBox.z*_this._viewScale)/_this._viewScale),_this.valueText.attr("y",(ev.offsetY-20*_this._viewScale+_this._viewBox.w*_this._viewScale)/_this._viewScale),_this.valueText.attr("text",toValue.toFixed(4)),clearTimeout(_this._positionHelperTimeout),_this._positionHelperTimeout=setTimeout(function(){_this._positionHelperMesh=helpers_1.default.AddPositionLineMesh(_this.editor.core.scene,_this.animation)},5)},onEnd=function(ev){data.point.attr("opacity",.3),ox=lx,oy=ly,_this.valueText.hide(),_this.updateGraph(_this.animation);var key=_this.key,animation=_this.animation;_this._xLocked||babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,object:key,property:"frame",from:fromFrame,to:toFrame,fn:function(type){_this.updateGraph(animation),_this.frameInput.val("from"===type?fromFrame:toFrame)}}),babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,object:key,property:""===data.property?"value":"value."+data.property,from:fromValue,to:toValue,fn:function(){_this.updateGraph(animation)}}),_this.editor.core.onModifiedObject.notifyObservers(_this.animatable)};data.point.drag(onMove,onStart,onEnd)},AnimationEditor.prototype.onMoveCursor=function(maxFrame){var _this=this,baseX=this.cursorLine.attr("x"),ox=0,lx=0,doAnimatables=function(animatables,frame){animatables.forEach(function(a){if(a&&a!==_this.animatable)if(a.animations){var animatable=_this.editor.core.scene.getAnimatableByTarget(a);animatable||(animatable=new babylonjs_1.Animatable(_this.editor.core.scene,a,frame,maxFrame,!1,1)),animatable.appendAnimations(a,a.animations),animatable.stop(),animatable.goToFrame(frame)}else a.getAnimatables&&a.getAnimatables().forEach(function(a){var animatable=_this.editor.core.scene.getAnimatableByTarget(a);animatable||(animatable=new babylonjs_1.Animatable(_this.editor.core.scene,a,frame,maxFrame,!1,1)),animatable.appendAnimations(a,a.animations),animatable.stop(),animatable.goToFrame(frame)})})},onStart=function(x,y,ev){_this.cursorRect.attr("opacity",.1)},onMove=function(dx,dy,x,y,ev){lx=dx+ox,_this.cursorRect.transform("t"+lx+",0"),_this.cursorLine.transform("t"+lx+",0"),_this.currentFrame=babylonjs_1.Scalar.Clamp((lx+baseX)*maxFrame/_this.paper.width,0,maxFrame-1),_this.animationManager.stop(),_this.animationManager.goToFrame(_this.currentFrame),doAnimatables(_this.editor.core.scene.meshes,_this.currentFrame),doAnimatables(_this.editor.core.scene.meshes.map(function(m){return m.skeleton}),_this.currentFrame),doAnimatables(_this.editor.core.scene.cameras,_this.currentFrame),doAnimatables(_this.editor.core.scene.lights,_this.currentFrame),doAnimatables(_this.editor.core.scene.particleSystems,_this.currentFrame),doAnimatables([babylonjs_editor_1.SceneManager.StandardRenderingPipeline],_this.currentFrame)},onEnd=function(ev){_this.cursorRect.attr("opacity",.5),ox=lx};this.cursorRect.drag(onMove,onStart,onEnd)},AnimationEditor.prototype.onClickTimeline=function(maxFrame){var _this=this;this.timeline.mousedown(function(ev){_this.isPlaying||(_this.currentFrame=babylonjs_1.Scalar.Clamp(ev.offsetX*maxFrame/_this.paper.width,0,maxFrame-1),_this.animationManager.stop(),_this.animationManager.goToFrame(_this.currentFrame),_this.cursorRect.undrag(),_this.cursorRect.transform("t0,0"),_this.cursorLine.transform("t0,0"),_this.cursorRect.attr("x",ev.offsetX-20),_this.cursorLine.attr("x",ev.offsetX),_this.onMoveCursor(maxFrame))})},AnimationEditor.prototype.onPaperMove=function(properties,maxFrame,valueInterval,keys){var _this=this;this.background.unmousemove(this.mouseMoveHandler);var points=[];this.mouseMoveHandler=function(ev){_this.lines.forEach(function(l,index){if(!_this.addingKeys)return void points[index].hide();points[index].show();var length=l.getTotalLength(),position=l.getPointAtLength(ev.offsetX*length/_this.paper.width);_this.paper.width;points[index].transform("t"+position.x+","+position.y)})},properties.forEach(function(_,index){var color=AnimationEditor.Colors[index],circle=_this.paper.circle(0,0,6);circle.attr("fill",Raphael.rgb(color.r,color.g,color.b)),circle.click(function(ev){var frame=babylonjs_1.Scalar.Clamp(ev.offsetX*maxFrame/_this.paper.width,0,maxFrame-1),value=0;value=ev.offsetY>_this.paper.height/2?-(ev.offsetY-_this.paper.height/2)*valueInterval/(_this.paper.height/2)*2:(_this.paper.height/2-ev.offsetY)*valueInterval/(_this.paper.height/2)*2;for(var keyIndex=0,key={frame:frame,value:null},i=0;i<keys.length;i++)if(keys[i].frame>frame){keyIndex=i,keys.splice(i,0,key);break}var lastKey=keys[keyIndex-1];switch(properties.length){case 1:key.value=value;break;case 2:key.value=lastKey?(new babylonjs_1.Vector2).copyFrom(lastKey.value):new babylonjs_1.Vector2(value,value+1);break;case 3:switch(properties[0]){case"x":key.value=lastKey?(new babylonjs_1.Vector3).copyFrom(lastKey.value):new babylonjs_1.Vector3(value,value-1,value+1);break;case"r":key.value=lastKey?(new babylonjs_1.Color3).copyFrom(lastKey.value):new babylonjs_1.Color3(value,value,value)}}var animation=_this.animation;babylonjs_editor_1.UndoRedo.Push({scope:_this.divElement.id,fn:function(type){"from"===type?animation.getKeys().splice(keyIndex,1):animation.getKeys().splice(keyIndex,0,key),_this.updateGraph(animation)}}),_this.updateGraph(_this.animation)}),points.push(circle),_this.points.push(circle)}),this.background.mousemove(this.mouseMoveHandler)},AnimationEditor.PaperOffset=30,AnimationEditor.Colors=[new babylonjs_1.Color3(255,0,0),new babylonjs_1.Color3(0,255,0),new babylonjs_1.Color3(0,0,255),new babylonjs_1.Color3(0,0,0)],AnimationEditor._Properties={number:[""],Number:[""],Vector2:["x","y"],Vector3:["x","y","z"],Vector4:["x","y","z","w"],Quaternion:["x","y","z","w"],Color3:["r","g","b"],Color4:["r","g","b","a"]},AnimationEditor}(babylonjs_editor_1.EditorPlugin);exports.default=AnimationEditor})})(function(factory){module.exports=factory(require("babylonjs"),require("babylonjs-editor"),require("raphael"))});